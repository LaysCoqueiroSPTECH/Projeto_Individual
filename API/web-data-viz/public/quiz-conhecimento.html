<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreyVerse - Quiz</title>
    <link rel="stylesheet" href="css/style_botoes.css">
    <link rel="stylesheet" href="css/style_quiz_conhecimento.css">
    <link rel="shortcut icon" type="imagex/png" href="assets/imgs/logo.png">
</head>

<body>
    <header>
        <img src="assets/imgs/logo.png" alt="Logo - GreyVerse" height="100px" width="130px">
        <nav class="header_nav">
            <ul>
                <li><a href="/index.html#greys">Início</a></li>
                <li><a href="quiz-personagem.html">Quiz Personagem</a></li>
                <li><a href="quiz-conhecimento.html">Quiz Conhecimento</a></li>
                <li><a href="dashboard.html">Ranking</a></li>
            </ul>
        </nav>
    </header>
    <div class="quiz">
        <h1> O quanto você conhece de Greys ? </h1>
        <div class="perguntas">
            <h2> Questões </h2>
            <div id="botoes_quiz"></div>
            <button class="button_avancar">Avançar</button>
        </div>
    </div>
    <script>
        var questoes = [
            {
                questao: "Quem recebe o apelido de 007 ? ",
                respostas: [
                    { id: 1, text: "Alex Karev", correct: false },
                    { id: 2, text: "George O'marley", correct: true },
                    { id: 3, text: "Izzie", correct: false },
                    { id: 4, text: "Preston Burke", correct: false },
                ],
            },
            {
                questao: "Quantos episódios existem até a 20°temporada ? (Estava no texto sobre grey´s) ",
                respostas: [
                    { id: 1, text: "200", correct: false },
                    { id: 2, text: "249", correct: false },
                    { id: 3, text: "Mais de 400", correct: true },
                    { id: 4, text: "397", correct: false },
                ],
            },
            {
                questao: "Como se chamava o hospital na primeira temporada ? ",
                respostas: [
                    { id: 1, text: "Seattle Hospital", correct: false },
                    { id: 2, text: "Seattle Grey Hospital", correct: false },
                    { id: 3, text: "Seattle Grace Hospital", correct: true },
                    { id: 4, text: "Seattle Grace West", correct: false },
                ],
            },
            {
                questao: "O que a mãe da Meredith disse para ela quando ficou lúcida ? ",
                respostas: [
                    { id: 1, text: "Você é chata", correct: false },
                    { id: 2, text: "Estou com raiva de você", correct: false },
                    { id: 3, text: "Você é uma médica ruim", correct: false },
                    { id: 4, text: "Você é um ser humano comum", correct: true },
                ],

            },
            {
                questao: "O que causa intriga entre Meredit e Cristina no primeiro episódio? ",
                respostas: [
                    { id: 1, text: "Cristina descobriu sobre o Derek", correct: true },
                    { id: 2, text: "A amizade de Meredith e Izzie", correct: false },
                    { id: 3, text: "Cristina se achar melhor que Meredith", correct: false },
                    { id: 4, text: "Porque elas não se gostavam ainda", correct: false },
                ],
            },
            {
                questao: "Qual desses personagens não fazia parte da primeira temporada? ",
                respostas: [
                    { id: 1, text: "Miranda Bailey", correct: false },
                    { id: 2, text: "Alex Karev", correct: false },
                    { id: 3, text: "Callie Torres", correct: true },
                    { id: 4, text: "Richard Webber", correct: false },
                ],
            },
            {
                questao: "Em qual temporada a equipe do Mercy West passa a trabalhar no hospital principal da série? ",
                respostas: [
                    { id: 1, text: "6° temprada", correct: true },
                    { id: 2, text: "4° temporada", correct: false },
                    { id: 3, text: "5° temporada", correct: false },
                    { id: 4, text: "3° temporada", correct: false },
                ],
            },
            {
                questao: "Quem vira o chefe de cirurgia na 8° temporada ? ",
                respostas: [
                    { id: 1, text: "Derek Shepherd", correct: true },
                    { id: 2, text: "Mark Sloan", correct: false },
                    { id: 3, text: "Owen Hunt", correct: false },
                    { id: 4, text: "Miranda Bailey", correct: false },
                ],
            },
            {
                questao: " Qual era a touca que era marca registrada do Derek ? ",
                respostas: [
                    { id: 1, text: "Azul com simbolo de estetoscopio branco", correct: false },
                    { id: 2, text: "Azul marinho", correct: false },
                    { id: 3, text: "Azul marinho com nuances do mar", correct: false },
                    { id: 4, text: "De barcas", correct: true },
                ],
            },
            {
                questao: "Qual parte do hospital a Cristina ama e chama todos os internos para conhecerem? ",
                respostas: [
                    { id: 1, text: "Pediatria", correct: false },
                    { id: 2, text: "Dermatologia", correct: true },
                    { id: 3, text: "Psiquiatria", correct: false },
                    { id: 4, text: "Ala da Cardio", correct: false },
                ],
            },
        ];
        

    var perguntaTitulo = document.querySelector(".perguntas h2");
    var containerQuestoes = document.getElementById("botoes_quiz");
    var btnAvancar = document.querySelector(".button_avancar");

    var questaoAtual = 0;
    var pontuacao = 0;
    var erros = 0;

    function mostrarQuestao() {
        containerQuestoes.innerHTML = ""; // Limpa as respostas anteriores

        if (questaoAtual >= questoes.length) {
            perguntaTitulo.innerHTML = "Quiz Finalizado!";
            containerQuestoes.innerHTML = `
                <p>Sua pontuação: ${pontuacao} de ${questoes.length}</p>
                <p>Você errou: ${erros} questão(ões)</p>
            `;
            if (pontuacao <= 5) {
                containerQuestoes.innerHTML += `<span> <img src="assets/imgs/alex_urso.jpg" alt="Alex surtando pelo urso" style="height: 300px; width: 400px; margin-left: 5%;"></span>`;
            } else if (pontuacao == 6) {
                containerQuestoes.innerHTML += `<span> <img src="assets/imgs/bailey_ok.jpg" alt="Bailey dando um ok com a mão na sala de cirurgia" style="height: 300px; width: 300px; margin-left: 15%;"></span>`;
            } else if (pontuacao >= 7 && pontuacao < 10) {
                containerQuestoes.innerHTML += `<span> <img src="assets/imgs/Bokhee.jpg" alt="Bokhee com óculos engraçado" style="height: 300px; width: 300px; margin-left: 15%;"></span>`;
            } else if (pontuacao == 10) {
                containerQuestoes.innerHTML += `<span> <img src="assets/imgs/cristina_patinho.jpg" alt="Cristina de capa de chuva amarela" style="height: 300px; width: 300px; margin-left: 15%;"></span>`;
            }

            btnAvancar.style.display = "none";
            salvarPontuacaoNoBanco(pontuacao);
            return;
        }

        var q = questoes[questaoAtual];
        perguntaTitulo.innerHTML = "Pergunta " + (questaoAtual + 1) + ": " + q.questao;

        for (var i = 0; i < q.respostas.length; i++) {
            var resp = q.respostas[i];
            var btn = document.createElement("button");
            btn.innerText = resp.text;
            btn.className = "btn_quiz";

            (function (respostaCorreta, botao, questaoLocal) {
                botao.onclick = function () {
                    verificarResposta(respostaCorreta, botao, questaoLocal);

                    var botoes = document.getElementsByClassName("btn_quiz");
                    for (var j = 0; j < botoes.length; j++) {
                        botoes[j].disabled = true;
                    }
                    btnAvancar.disabled = false;
                };
            })(resp.correct, btn, q);

            containerQuestoes.appendChild(btn);
        }

        btnAvancar.disabled = true; // Impede avançar sem responder
    }

    // Recebe 3 parametros (correta vem do true e false), o botão que o usuário clicou,  questão o objeto de questão atual
    function verificarResposta(correta, botao, questao) {
        if (correta) {
            pontuacao++; // se estiver correta aumenta a pontuação e aparece essa cor 
            botao.style.backgroundColor = "#4CAF50";
        } else {
            erros++; // se estiver incorreta aumenta o erro e adiciona essa cor
            botao.style.backgroundColor = "#f44336";

            var respostas = questao.respostas;
            var botoes = document.getElementsByClassName("btn_quiz");
            for (var i = 0; i < respostas.length; i++) {
                if (respostas[i].correct) {
                    for (var j = 0; j < botoes.length; j++) {
                        if (botoes[j].innerText === respostas[i].text) {
                            botoes[j].style.backgroundColor = "#4CAF50"; // e preenche a que era para ser correta
                        }
                    }
                }
            }
        }
    }

    btnAvancar.addEventListener("click", function () {
        questaoAtual++;
        mostrarQuestao();
    });

    function salvarPontuacaoNoBanco(pontuacao) {
        console.log("Executando salvarPontuacaoNoBanco");
        console.log("Session Storage no quiz:", sessionStorage);
        var idDoUsuario = sessionStorage.getItem("usuarioId");
        console.log("ID do Usuário ao salvar:", idDoUsuario);
        var pontuacaoFinal = pontuacao;

        fetch('/quiz/salvar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                usuarioId: idDoUsuario,
                pontuacao: pontuacaoFinal
            })
        })
            .then(function (res) { return res.json(); })
            .then(function (data) { console.log("Resultado salvo:", data); })
            .catch(function (err) { console.error("Erro ao salvar pontuacao:", err); });
    }

    mostrarQuestao();
    console.log("ID do usuário na página do quiz:", sessionStorage.getItem("usuarioId"));
</script>